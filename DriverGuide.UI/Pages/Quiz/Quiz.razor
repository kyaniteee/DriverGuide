@page "/quiz/{Category}"
@using System.ComponentModel.DataAnnotations
@using DriverGuide.Domain.Models
@using DriverGuide.UI.Utils
@inject HttpClient Http
@inject IJSRuntime JS

<div class="quiz-container">
    @if (currentQuestion is null)
    {
        <div class="quiz-loading">
            <div class="blue-spinner"></div>
            <p style="text-align: center; font-size: 2rem; font-weight: bold; margin-top: 1.5rem;">
                Trwa przygotowanie pytań testowych dla kategorii @Category?.Replace('_', ',') ...
            </p>
        </div>
    }
    else
    {
        <p style="text-align: center; font-size: 2rem; font-weight: bold;">Test na prawo jazdy kategorii @Category</p>

        <p class="progress-text">Pytanie @(currentIndex + 1) z @questionsCount</p>

        <hr class="question-underline" />

        @if (isLoadingQuestion)
        {
            <div class="question-loading">
                <div class="blue-spinner"></div>
                <p>Ładowanie pytania...</p>
            </div>
        }
        else
        {
            <div class="quiz-question">

                @if (!string.IsNullOrWhiteSpace(fileBlobUrl))
                {
                    var mimeType = !string.IsNullOrEmpty(currentQuestion.Media) ? Utils.FileExtensionUtils.GetMimeType(currentQuestion.Media) : string.Empty;
                    if (mimeType.StartsWith("video/"))
                    {
                        <div class="video-container">
                            @if (isVideoLoading)
                            {
                                <div class="media-loading-overlay">
                                    <div class="blue-spinner"></div>
                                    <p>Wczytywanie wideo...</p>
                                </div>
                            }
                            <video id="questionVideo"
                                   src="@fileBlobUrl"
                                   controls
                                   preload="auto"
                                   class="media-content"
                                   @onloadstart="OnVideoLoadStart"
                                   @oncanplay="OnVideoCanPlay"
                                   @onerror="OnVideoError">
                                Twoja przeglądarka nie obsługuje odtwarzania wideo.
                            </video>
                        </div>
                    }
                    else
                    {
                        <img src="@fileBlobUrl" class="media-content" alt="Question media" />
                    }
                }

                <p class="question-text">@currentQuestion.Pytanie</p>

                <div class="answers-list">
                    @foreach (var answer in GetCurrentQuestionAnswers())
                    {
                        <div class="answer-option" @onclick="() => SelectAnswer(answer)">
                            <input type="radio"
                                   id="@answer"
                                   name="answer"
                                   value="@answer"
                                   checked="@(selectedAnswer == answer)"
                                   class="custom-radio"
                                   @onchange="() => SelectAnswer(answer)" />
                            <label for="@answer" class="radio-label">@answer</label>
                        </div>
                    }
                </div>

                <div class="submit-section">
                    <div class="submit-section-right">
                        @if (string.IsNullOrWhiteSpace(selectedAnswer))
                        {
                            <button class="btn btn-primary" disabled>
                                @if (currentIndex == questionsCount - 1)
                                {
                                    <b>Zakończ test</b>
                                }
                                else
                                {
                                    <b>Następne pytanie</b>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-warning" @onclick="SubmitAnswer">
                                @if (currentIndex == questionsCount - 1)
                                {
                                    <b>Zakończ test</b>
                                }
                                else
                                {
                                    <b>Następne pytanie</b>
                                }
                            </button>
                        }
                    </div>
                </div>

            </div>
        }
    }
</div>